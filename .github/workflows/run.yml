name: Esecuzione Probabili Serie A

on:
  workflow_dispatch:
  # Se vuoi anche una schedulazione, togli il commento qui sotto e imposta il cron
  # schedule:
  #   - cron: "0 5-22 * * 1-3"   # Lunedì-Mercoledì ogni ora (06–23 italiane ≈ 05–22 UTC in inverno)
  #   - cron: "0,30 5-22 * * 4"  # Giovedì ogni 30 minuti
  #   - cron: "*/10 5-22 * * 5,6" # Venerdì-Sabato ogni 10 minuti
  #   - cron: "0,30 5-22 * * 0"   # Domenica ogni 30 minuti

jobs:
  prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Se usi Playwright per lo scraping, tieni queste righe:
          if command -v playwright >/dev/null 2>&1; then
            playwright install --with-deps chromium || true
          fi

      # === Decodifica credenziali Google da secret base64 ===
      - name: Decode Google credentials (Base64) -> credentials.json
        env:
          GOOGLE_CREDENTIALS_B64: ${{ secrets.GOOGLE_CREDENTIALS_B64 }}
        run: |
          if [ -z "${GOOGLE_CREDENTIALS_B64}" ]; then
            echo "❌ Secret GOOGLE_CREDENTIALS_B64 mancante."
            exit 1
          fi
          echo "${GOOGLE_CREDENTIALS_B64}" | base64 -d > credentials.json
          echo "Credenziali decodificate."
          echo "Bytes in credentials.json: $(wc -c < credentials.json)"

      # === Debug: mostra il sorgente numerato e compila prima di eseguire ===
      - name: (Debug) mostra probabili.py numerato
        run: |
          echo "=== probabili.py (prime 200 righe) ==="
          nl -ba probabili.py | sed -n '1,200p'

      - name: (Debug) compila probabili.py (blocca errori di sintassi)
        run: |
          python - << 'PY'
          import py_compile
          py_compile.compile('probabili.py', doraise=True)
          print('Compilazione OK.')
          PY

      # === Esecuzione ===
      - name: Run production script
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/credentials.json
          # Secret/variable con URL o ID della cartella Drive di destinazione
          DRIVE_FOLDER_URL: ${{ secrets.DRIVE_FOLDER_URL }}
          # Glob per cercare le PNG da caricare (puoi cambiarlo)
          IMAGE_GLOB: "**/*.png"
        run: |
          echo "Esecuzione probabili.py"
          echo "DRIVE_FOLDER_URL (mascherato se secret): ${DRIVE_FOLDER_URL:+***}"
          echo "IMAGE_GLOB: ${IMAGE_GLOB}"
          python probabili.py

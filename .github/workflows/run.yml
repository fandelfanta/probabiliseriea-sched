name: Esegui Scraper Probabili Formazioni

# 1. Trigger del Workflow
on:
  # Permette l'esecuzione manuale dalla scheda Actions
  workflow_dispatch:
  
  # Schedulazione tramite sintassi Cron (orari in UTC)
  schedule:
    # Lunedì, Martedì, Mercoledì: Ogni ora, dalle 04:00 alle 23:59 UTC
    # 0 4-23/1 * * 1-3 -> Ogni ora intera tra le 4 e le 22 UTC
    - cron: '0 4-23/1 * * 1-3'

    # Giovedì: Ogni mezz'ora (ai minuti 0 e 30), dalle 04:00 alle 23:30 UTC
    # 0,30 4-23 * * 4 -> Ai minuti 0 e 30 di ogni ora tra le 4 e le 22 UTC
    - cron: '0,30 4-23 * * 4'

    # Venerdì, Sabato: Ogni 10 minuti, dalle 04:00 alle 23:50 UTC
    # */10 4-22 * * 5,6 -> Ogni 10 minuti di ogni ora tra le 4 e le 22 UTC
    - cron: '*/10 4-23 * * 5,6'

    # Domenica: Ogni mezz'ora (ai minuti 0 e 30), dalle 04:00 alle 23:30 UTC
    - cron: '0,30 4-23 * * 0'

jobs:
  run_scraper:
    # Esegue il job sul runner Linux (ubuntu-latest)
    runs-on: ubuntu-latest
    # Imposta un timeout massimo di 15 minuti per il job (utile per lo scraping)
    timeout-minutes: 15 

    steps:
    # Step 1: Clona il tuo repository sul runner
    - uses: actions/checkout@v4

    # Step 2: Configura l'ambiente Python
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # Step 3: Installa le dipendenze Python e i browser di Playwright
    - name: Install dependencies and Playwright Browsers
      run: |
        # Installazione normale
        pip install -r requirements.txt
        # Installazione esplicita della libreria che gestisce il client Drive (sicurezza)
        pip install google-api-python-client
        # Installa il browser Chromium necessario per lo scraping
        playwright install chromium
        
    # Step 4: Esecuzione dello script Python consolidato (e autenticazione)
    - name: Run Python Scraper and Upload to Drive
      # Passiamo il secret GOOGLE_CREDENTIALS_B64 allo script Python come variabile d'ambiente
      env:
        GOOGLE_CREDENTIALS_B64: ${{ secrets.GOOGLE_CREDENTIALS_B64 }}
      run: python run.py
      
    # Step 5 (Opzionale ma Utile per Debug): Carica gli screenshot come Artifacts
    - name: Upload Screenshots Artifact
      uses: actions/upload-artifact@v4
      with:
        # Nome dell'archivio zip da scaricare
        name: screenshots-risultati
        # Percorsi dei file da includere nell'archivio
        path: |
          sosfanta_*.png
          fantacalcio_*.png
          gazzetta_*.png
        # Consente la sovrascrittura nelle successive esecuzioni
        overwrite: true

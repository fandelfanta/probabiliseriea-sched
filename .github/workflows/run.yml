name: Esecuzione Probabili Serie A

on:
  schedule:
    # Lunedì–Mercoledì ogni ora
    - cron: "0 5-22 * * 1-3"
    # Giovedì ogni 30 minuti
    - cron: "*/30 5-22 * * 4"
    # Venerdì–Sabato ogni 10 minuti
    - cron: "*/10 5-22 * * 5,6"
    # Domenica ogni 30 minuti
    - cron: "*/30 5-22 * * 0"
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install --with-deps chromium

      # --- decodifica del secret con le credenziali GCP ---
      - name: Decode Google Credentials (base64 -> credentials.json)
        env:
          GOOGLE_CREDENTIALS_B64: ${{ secrets.GOOGLE_CREDENTIALS_B64 }}
        run: |
          echo "$GOOGLE_CREDENTIALS_B64" | base64 -d > credentials.json
          python - <<'PY'
          import json, sys
          try:
              info = json.load(open("credentials.json"))
              print("Credenziali decodificate. tipo:", info.get("type"))
          except Exception as e:
              print("ERRORE decodifica credenziali:", e, file=sys.stderr); sys.exit(1)
          PY

      # --- esecuzione del tuo script ---
      - name: Run production script
        env:
          # passiamo esplicitamente la variabile che lo script legge
          DRIVE_FOLDER_URL: ${{ secrets.DRIVE_FOLDER_URL }}
          # opzionale: pattern dei file da caricare (se lo usi nello script)
          IMAGE_GLOB: "output/**/*.png"
          # credenziale per le librerie Google
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/credentials.json
        run: |
          echo "Esecuzione probabili.py"
          python probabili.py
